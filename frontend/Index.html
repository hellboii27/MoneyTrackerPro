<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
  <title>Money Tracker Pro</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  
  <style>
    /* Global Styles & Variables */
    :root { --primary: #0f172a; --accent: #2563eb; --bg: #f8fafc; --text-main: #1e293b; --text-muted: #64748b; --success-emerald: #10b981; }
    body { background: var(--bg); font-family: 'Plus Jakarta Sans', sans-serif; color: var(--text-main); padding-bottom: 30px; overflow-x: hidden; }
    
    /* Layout Components */
    .header-app { padding: 30px 0 20px; text-align: center; }
    .header-app h1 { font-weight: 800; font-size: 1.4rem; color: var(--primary); letter-spacing: -0.5px; }
    .header-app h1 span { color: var(--accent); }
    .nav-custom { background: #fff; border-radius: 20px; padding: 6px; margin-bottom: 25px; border: 1px solid rgba(0,0,0,0.04); box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
    .nav-custom .nav-link { border-radius: 15px; color: var(--text-muted); font-weight: 700; font-size: 0.85rem; border: none; padding: 12px; transition: 0.3s; }
    .nav-custom .nav-link.active { background: var(--primary) !important; color: #fff !important; box-shadow: 0 8px 16px rgba(15, 23, 42, 0.15); }
    
    /* Card Components */
    .glass-card { background: #fff; border-radius: 28px; padding: 25px; margin-bottom: 18px; border: 1px solid rgba(0,0,0,0.02); box-shadow: 0 10px 30px -5px rgba(0,0,0,0.05); }
    .balance-card { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white; border-radius: 28px; padding: 30px; margin-bottom: 20px; text-align: center; box-shadow: 0 15px 35px -10px rgba(15, 23, 42, 0.3); }
    .balance-card h2 { font-weight: 800; font-size: 1.8rem; margin-top: 8px; }
    
    /* Form & Input Elements */
    .wallet-wrapper { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .balance-info { color: var(--success-emerald); font-size: 0.75rem; font-weight: 800; background: rgba(16, 185, 129, 0.1); padding: 4px 12px; border-radius: 10px; }
    .form-label-custom { font-size: 0.7rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; display: block; }
    .form-control, .form-select { border-radius: 16px; border: 1.5px solid #f1f5f9; padding: 14px; font-size: 0.95rem; background: #f8fafc; font-weight: 600; }
    .btn-main { background: var(--primary); color: #fff; border-radius: 18px; padding: 18px; font-weight: 800; width: 100%; border: none; box-shadow: 0 10px 20px rgba(15, 23, 42, 0.2); }
    
    /* FIX UI Slide */
    .trx-item-wrapper { position: relative; overflow: hidden; border-radius: 20px; margin-bottom: 12px; touch-action: pan-y; background: transparent; }
    .slide-action { position: absolute; top: 0; bottom: 0; width: 100px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 0.75rem; color: white; z-index: 1; opacity: 0; visibility: hidden; transition: opacity 0.2s; }
    .action-edit { left: 0; background: var(--accent); border-radius: 20px 0 0 20px; }
    .action-delete { right: 0; background: #ef4444; border-radius: 0 20px 20px 0; }
    .trx-card-old { position: relative; z-index: 2; display: flex; align-items: center; background: #fff; border-radius: 20px; padding: 18px; margin-bottom: 0 !important; border-left: 6px solid; transition: transform 0.25s cubic-bezier(0.2, 0.8, 0.2, 1); }
    
    .cat-icon-box { width: 45px; height: 45px; border-radius: 14px; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 1.2rem; }
    .cat-item { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid #f1f5f9; }
    .progress-wrap { height: 7px; background: #f1f5f9; border-radius: 10px; overflow: hidden; margin-top: 8px; }
    .progress-bar-fill { height: 100%; border-radius: 10px; }
    .filter-pills { display: flex; gap: 10px; padding: 5px 0 20px; justify-content: center; overflow-x: auto; scrollbar-width: none; }
    .btn-pill { border-radius: 14px; border: 1px solid #e2e8f0; background: #fff; font-size: 0.75rem; font-weight: 700; padding: 10px 18px; color: var(--text-muted); transition: 0.2s; }
    .btn-pill.active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .toggle-stats { background: #fff; border-radius: 16px; padding: 5px; display: flex; margin-bottom: 20px; border: 1px solid #e2e8f0; }
    .toggle-stats button { flex: 1; border: none; padding: 12px; border-radius: 12px; font-weight: 800; font-size: 0.8rem; background: transparent; color: var(--text-muted); transition: 0.3s; }
    .toggle-stats button.active { background: var(--primary); color: #fff; box-shadow: 0 5px 15px rgba(15, 23, 42, 0.2); }
    #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 9999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
    .footer-app { padding: 25px 0; text-align: center; }
    .footer-app p { font-size: 0.7rem; font-weight: 800; color: var(--text-muted); opacity: 0.7; }
    .toast-container { z-index: 10000; bottom: 40px !important; }
    .toast { width: max-content !important; margin: 0 auto !important; border-radius: 16px !important; background: #0f172a !important; color: #fff !important; border: none !important; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    .toast-body { padding: 12px 20px !important; font-size: 0.85rem; }

    /* Fix 1-Click Date Picker */
    .date-input-container { position: relative; width: 100%; }
    input[type="date"].form-control { color: transparent; position: relative; }
    input[type="date"].form-control:focus, 
    input[type="date"].form-control:valid { color: var(--text-main); }
    
    input[type="date"].form-control::before {
      content: attr(placeholder);
      position: absolute;
      left: 14px;
      color: var(--text-muted);
      pointer-events: none;
      }
      input[type="date"].form-control:focus::before,
      input[type="date"].form-control:valid::before {
        display: none !important;
        }
    
  </style>
</head>
<body>

<div id="loader"><div class="spinner-border text-primary"></div></div>

<div class="toast-container position-fixed bottom-0 start-50 translate-middle-x p-3">
  <div id="toastSuccess" class="toast align-items-center" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex"><div class="toast-body fw-bold">‚úÖ Berhasil diproses!</div></div>
  </div>
</div>

<div class="modal fade" id="modalConfirm" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered mx-auto" style="max-width: 350px;">
    <div class="modal-content" style="border-radius: 24px; border: none; box-shadow: 0 20px 40px rgba(0,0,0,0.2);">
      <div class="modal-body text-center p-4">
        <div class="mb-3" style="font-size: 2.5rem;">üóëÔ∏è</div>
        <h6 class="fw-800 mb-2">Hapus Transaksi?</h6>
        <p class="text-muted small mb-4">Tindakan ini tidak dapat dibatalkan dan saldo akan disesuaikan kembali.</p>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-light w-100 fw-bold py-2" style="border-radius: 12px;" data-bs-dismiss="modal" onclick="resetSlide()">Batal</button>
          <button type="button" class="btn btn-danger w-100 fw-bold py-2" style="border-radius: 12px; background: #ef4444;" onclick="executeDelete()">Hapus</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container py-2" style="max-width: 480px;">
  <div class="header-app"><h1>Money Tracker <span>Pro</span></h1></div>

  <ul class="nav nav-custom nav-fill" id="mainTab">
    <li class="nav-item"><button class="nav-link active" id="tab-in-btn" data-bs-toggle="pill" data-bs-target="#tab-in" type="button">Input</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-list" type="button" onclick="fetchTransactions()">Riwayat</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-st" type="button" onclick="fetchDashboard()">Statistik</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-ex" type="button">Ekspor</button></li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active" id="tab-in" role="tabpanel">
      <div class="glass-card">
        <form id="mainForm" onsubmit="handleSave(event)">
          <input type="hidden" id="editRowId">
          <div class="mb-3">
            <label class="form-label-custom">Jenis Transaksi</label>
            <select class="form-select" id="tipe" onchange="toggleUI()">
              <option value="Pengeluaran">üî¥ Pengeluaran</option>
              <option value="Pemasukan">üü¢ Pemasukan</option>
              <option value="Transfer">üîµ Transfer</option>
            </select>
          </div>
          <div id="kat-area" class="mb-3"><label class="form-label-custom">Kategori</label><select class="form-select" id="kategori" onchange="checkLainnya()"></select></div>
          <div id="kat-kustom-area" class="mb-3" style="display:none;"><label class="form-label-custom">Kategori Baru</label><input type="text" class="form-control" id="kategoriKustom" placeholder="Masukkan Kategori..."></div>
          <div class="mb-3"><label class="form-label-custom">Tanggal & Waktu</label><input type="datetime-local" class="form-control" id="tglInput" required></div>
          <div class="mb-3">
            <div class="wallet-wrapper">
                <label class="form-label-custom">Sumber Dana</label>
                <span id="display-saldo" class="balance-info">Saldo - Rp 0</span>
            </div>
            <select class="form-select" id="wallet" onchange="updateSaldoDisplay()"></select>
          </div>
          <div id="tujuan-area" style="display:none;" class="mb-3"><label class="form-label-custom">Tujuan Transfer</label><select class="form-select" id="walletTujuan"></select></div>
          <div class="mb-3"><label class="form-label-custom">Nominal</label><input type="text" class="form-control" id="jumlah" oninput="formatRp(this)" placeholder="Rp " required></div>
          <div class="mb-4"><label class="form-label-custom">Catatan</label><input type="text" class="form-control" id="catatan" placeholder="(Opsional)"></div>
          <button type="submit" class="btn-main" id="btn-submit">SIMPAN TRANSAKSI</button>
        </form>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-list" role="tabpanel">
      <div class="filter-pills">
        <button id="h-d-7" class="btn-pill" onclick="updateHDate(7)">Minggu Ini</button>
        <button id="h-d-30" class="btn-pill active" onclick="updateHDate(30)">Bulan Ini</button>
        <button id="h-d-365" class="btn-pill" onclick="updateHDate(365)">Tahun Ini</button>
        <button id="h-d-custom" class="btn-pill" onclick="toggleCustomFilter('H')">Kustom</button>
      </div>
      <div id="custom-date-H" class="glass-card mb-3 d-flex gap-2 justify-content-center align-items-center" style="display:none !important; padding:15px;">
        <input type="date" class="form-control py-1 px-2" id="h-start" style="width:130px; font-size:0.75rem;"> 
        <span class="small fw-bold">-</span> 
        <input type="date" class="form-control py-1 px-2" id="h-end" style="width:130px; font-size:0.75rem;">
        <button class="btn btn-dark btn-sm rounded-3" onclick="applyCustomDate('H')">OK</button>
      </div>
      <div id="transaction-list"></div>
      <div class="pagination-container d-flex justify-content-center align-items-center gap-3 mt-4" id="pagination-ctrl" style="display:none;">
        <button class="btn btn-sm btn-light fw-800 px-3 rounded-pill shadow-sm" onclick="changePage(-1)" id="btn-prev">‚Üê</button>
        <span id="pageDisplay" class="small fw-800 text-muted">1 / 1</span>
        <button class="btn btn-sm btn-light fw-800 px-3 rounded-pill shadow-sm" onclick="changePage(1)" id="btn-next">‚Üí</button>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-st" role="tabpanel">
      <div class="balance-card"><small class="text-uppercase opacity-70 fw-bold" style="font-size:0.65rem; letter-spacing:1px;">Total Saldo</small><h2 id="total-semua-saldo">Rp 0</h2></div>
      <div class="glass-card mb-3"><div id="wallet-list"></div></div>
      <div class="filter-pills">
        <button id="s-d-7" class="btn-pill" onclick="updateSDate(7)">Minggu Ini</button>
        <button id="s-d-30" class="btn-pill active" onclick="updateSDate(30)">Bulan Ini</button>
        <button id="s-d-365" class="btn-pill" onclick="updateSDate(365)">Tahun Ini</button>
        <button id="s-d-custom" class="btn-pill" onclick="toggleCustomFilter('S')">Kustom</button>
      </div>
      <div id="custom-date-S" class="glass-card mb-3 d-flex gap-2 justify-content-center align-items-center" style="display:none !important; padding:15px;">
        <input type="date" class="form-control py-1 px-2" id="s-start" style="width:130px; font-size:0.75rem;"> 
        <span class="small fw-bold">-</span> 
        <input type="date" class="form-control py-1 px-2" id="s-end" style="width:130px; font-size:0.75rem;">
        <button class="btn btn-dark btn-sm rounded-3" onclick="applyCustomDate('S')">OK</button>
      </div>
      <div class="toggle-stats shadow-sm">
        <button id="s-t-Pengeluaran" class="active" onclick="updateSFilter('tipe','Pengeluaran')">Pengeluaran</button>
        <button id="s-t-Pemasukan" onclick="updateSFilter('tipe','Pemasukan')">Pemasukan</button>
      </div>
      <div class="glass-card">
        <div style="height:230px; position:relative;"><canvas id="myChart"></canvas></div>
        <div id="cat-list" class="mt-4"></div>
      </div>
    </div>

<div class="tab-pane fade" id="tab-ex" role="tabpanel">
  <div class="glass-card">
    <label class="form-label-custom">Periode Transaksi</label>
    
    <div class="d-flex gap-2 mb-3">
      <div class="date-input-container">
        <input type="date" class="form-control" id="ex-start" placeholder="Tanggal Mulai" required>
      </div>
      <div class="date-input-container">
        <input type="date" class="form-control" id="ex-end" placeholder="Tanggal Akhir" required>
      </div>
    </div>

    <button class="btn-main mb-3" onclick="processExport()">GENERATE PREVIEW</button>

    <div id="export-preview-area" style="display:none;">
      <div class="table-responsive">
        <table class="table table-bordered table-sm small fw-bold" id="table-export" style="font-size: 0.7rem;">
          <thead class="table-dark">
            <tr><th>Kode PP</th><th>Tanggal</th><th>Dompet</th><th>Keterangan</th><th>Catatan</th><th>Debit</th><th>Kredit</th><th>Total</th></tr>
          </thead>
          <tbody id="export-body"></tbody>
        </table>
      </div>
      <button class="btn btn-success w-100 fw-800 rounded-pill mt-3 py-3" onclick="downloadCSV()">DOWNLOAD CSV</button>
    </div>
  </div>
</div>

  <div class="footer-app"><p>&copy; 2026 Bayu Wicaksono | v4.3.0 | All Rights Reserved.</p></div>
</div>

<script>

  /** Global bridge to server-side functions */
  function runServer(method, payload, success){
  loading(true);
  const runner = google.script.run
    .withSuccessHandler(res=>{
      loading(false);
      success && success(res);
    })
    .withFailureHandler(err=>{
      loading(false);
      alert(err.message || "Terjadi error server");
    });
  if(payload === undefined || payload === null){
    runner[method]();
  }else{
    runner[method](payload);
  }
  }

  /** Escapes HTML characters for security */
  function escapeHtml(str){
    if(!str) return "";
    return str.replace(/[&<>"']/g,m=>({
      '&':'&amp;',
      '<':'&lt;',
      '>':'&gt;',
      '"':'&quot;',
      "'":'&#039;'
    })[m]);
  }

  /** Global state and configuration */
  let hF = { tipe: 'Semua', start: '', end: '' }, sF = { tipe: 'Pengeluaran', start: '', end: '' }, chartObj = null;
  let allTrx = [], curPage = 1, walBalArr = []; const rows = 10;
  let startX = 0, currentX = 0, isDragging = false, deleteIdxTemp = null;

  const CAT_MAP = { 
    "Makan & Minum": { c: "#f59e0b", i: "üç¥" }, "Transportasi": { c: "#10b981", i: "üöó" }, 
    "Belanja": { c: "#ec4899", i: "üõçÔ∏è" }, "Tempat Tinggal": { c: "#3b82f6", i: "üè†" }, 
    "Keluarga": { c: "#ef4444", i: "üë®‚Äçüë©‚Äçüëß" }, "Hiburan": { c: "#8b5cf6", i: "üéÆ" }, 
    "Fintech": { c: "#0ea5e9", i: "üí≥" }, "Kesehatan": { c: "#f43f5e", i: "üè•" }, 
    "Teman": { c: "#fb923c", i: "ü§ù" }, "Hewan Peliharaan": { c: "#4ade80", i: "üêæ" }, 
    "Keuangan": { c: "#6366f1", i: "üí∞" }, "Pribadi": { c: "#a855f7", i: "üë§" }, 
    "Sistem": { c: "#94a3b8", i: "‚öôÔ∏è" }, "Gaji": { c: "#059669", i: "üíµ" }, 
    "Bisnis": { c: "#1d4ed8", i: "üè¢" }, "Investasi": { c: "#7c3aed", i: "üìà" }, 
    "Hadiah": { c: "#d97706", i: "üéÅ" }, "Lainnya": { c: "#475569", i: "üì¶" } 
  };

  /** Returns hex color for a category string */
  function getDynamicColor(str) { if (CAT_MAP[str]) return CAT_MAP[str].c; let hash = 0; for (let i = 0; i < str.length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); } let color = '#'; for (let i = 0; i < 3; i++) { let value = (hash >> (i * 8)) & 0xFF; value = Math.floor((value + 150) / 2); color += ('00' + value.toString(16)).substr(-2); } return color; }
  
  /** Returns icon for a category string */
  function getDynamicIcon(str) { return CAT_MAP[str]?.i || 'üè∑Ô∏è'; }
  
  /** Toggles global loading overlay */
  function loading(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }
  
  /** Formats input value into Indonesian Rupiah */
  function formatRp(e) { let v = e.value.replace(/\D/g, ""); e.value = v ? "Rp " + new Intl.NumberFormat('id-ID').format(v) : ""; }
  
  /** Shows success toast notification */
  function showToast() { const toastEl = document.getElementById('toastSuccess'); const toast = new bootstrap.Toast(toastEl, { delay: 3000 }); toast.show(); }
  
  /** Updates individual wallet balance display */
  function updateSaldoDisplay() { const sel = document.getElementById('wallet').value; const found = walBalArr.find(w => w.name === sel); document.getElementById('display-saldo').innerText = `Saldo - Rp ${new Intl.NumberFormat('id-ID').format(found ? found.balance : 0)}`; }

  /** Handles swipe start event */
  function ts(e, i) { startX = e.touches[0].clientX; isDragging = true; const wrapper = document.getElementById(`card-${i}`).parentElement; wrapper.querySelectorAll('.slide-action').forEach(el => { el.style.visibility = 'visible'; el.style.opacity = '1'; }); }
  
  /** Handles swipe movement event */
  function tm(e, i) { if (!isDragging) return; currentX = e.touches[0].clientX - startX; const card = document.getElementById(`card-${i}`); if (currentX > 0) card.style.transform = `translateX(${Math.min(currentX, 100)}px)`; else card.style.transform = `translateX(${Math.max(currentX, -100)}px)`; }
  
  /** Handles swipe end event */
  function te(e, i) { isDragging = false; const card = document.getElementById(`card-${i}`); if (currentX > 60) card.style.transform = `translateX(100px)`; else if (currentX < -60) card.style.transform = `translateX(-100px)`; else { card.style.transform = `translateX(0)`; setTimeout(() => { const wrapper = card.parentElement; wrapper.querySelectorAll('.slide-action').forEach(el => { el.style.opacity = '0'; el.style.visibility = 'hidden'; }); }, 200); } currentX = 0; }

  /** Populates form with existing transaction data */
  function handleEdit(idx) { const t = allTrx[idx]; document.getElementById('tipe').value = t.tipe.includes('Transfer') ? 'Transfer' : t.tipe; toggleUI(); const kategoriSelect = document.getElementById('kategori'); const options = Array.from(kategoriSelect.options).map(opt => opt.value); if (options.includes(t.kat)) { kategoriSelect.value = t.kat; document.getElementById('kat-kustom-area').style.display = 'none'; } else { kategoriSelect.value = 'Lainnya'; document.getElementById('kategoriKustom').value = t.kat; document.getElementById('kat-kustom-area').style.display = 'block'; } document.getElementById('wallet').value = t.wallet; document.getElementById('catatan').value = t.note; document.getElementById('jumlah').value = "Rp " + t.nominal.toLocaleString('id-ID'); document.getElementById('tglInput').value = t.tglRaw; document.getElementById('editRowId').value = t.row; document.getElementById('editRowId').dataset.trxid = t.trxId || ""; document.getElementById('btn-submit').innerText = "UPDATE TRANSAKSI"; document.getElementById('tab-in-btn').click(); document.getElementById(`card-${idx}`).style.transform = 'translateX(0)'; }
  
  /** Prepares transaction deletion */
  function handleDelete(idx) { deleteIdxTemp = idx; const modal = new bootstrap.Modal(document.getElementById('modalConfirm')); modal.show(); }
  
  /** Finalizes transaction deletion on server */
  function executeDelete() { if (deleteIdxTemp === null) return; const t = allTrx[deleteIdxTemp]; const modal = bootstrap.Modal.getInstance(document.getElementById('modalConfirm')); modal.hide(); runServer("hapusTransaksi", t.row, ()=>{ fetchTransactions(); loadWallets(); deleteIdxTemp = null; showToast(); }); }
  
  /** Resets swipe position if cancelled */
  function resetSlide() { if (deleteIdxTemp !== null) { const card = document.getElementById(`card-${deleteIdxTemp}`); if(card){ card.style.transform = 'translateX(0)'; setTimeout(() => { const wrapper = card.parentElement; wrapper.querySelectorAll('.slide-action').forEach(el => { el.style.opacity = '0'; el.style.visibility = 'hidden'; }); }, 200); } deleteIdxTemp = null; } }

  /** Fetches transaction history from server */
  function fetchTransactions() { runServer("getTransactions", hF, data=>{ allTrx=data; curPage=1; renderTrx();}); }
  
  /** Fetches and renders dashboard statistical data */
  function fetchDashboard() { runServer("getDashboardData", sF, data=>{ document.getElementById('total-semua-saldo').innerText = "Rp " + data.totalSemua.toLocaleString('id-ID'); document.getElementById('wallet-list').innerHTML = data.walletDetails.map(w => `<div class="d-flex justify-content-between py-2 small fw-bold border-bottom"><span>${escapeHtml(w.name)}</span><span>Rp ${w.balance.toLocaleString('id-ID')}</span></div>`).join(''); const sortK = Object.keys(data.catStats).sort((a, b) => data.catStats[b] - data.catStats[a]); const val = sortK.map(l => data.catStats[l]), col = sortK.map(l => getDynamicColor(l)), tot = data.totalFiltered; if (chartObj) chartObj.destroy(); chartObj = new Chart(document.getElementById('myChart'), { type: 'doughnut', data: { labels: sortK, datasets: [{ data: val, backgroundColor: col, borderWidth: 0 }] }, options: { cutout: '82%', plugins: { legend: { display: false } }, maintainAspectRatio: false }, plugins: [{ beforeDraw: (c) => { const { ctx, width, height } = c; ctx.restore(); ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.font = '800 1.1rem Plus Jakarta Sans'; ctx.fillStyle = '#1e293b'; ctx.fillText('Rp ' + tot.toLocaleString('id-ID'), width / 2, height / 2); ctx.save(); } }] }); document.getElementById('cat-list').innerHTML = sortK.map((l, i) => { const p = tot > 0 ? ((val[i] / tot) * 100).toFixed(0) : 0; return `<div class="cat-item"><div class="cat-icon-box" style="background:${col[i]}15; color:${col[i]}">${getDynamicIcon(l)}</div><div class="flex-grow-1"><div class="d-flex justify-content-between"><span class="small fw-bold">${escapeHtml(l)}</span><span class="small fw-bold">Rp ${val[i].toLocaleString('id-ID')}</span></div><div class="progress-wrap"><div class="progress-bar-fill" style="width:${p}%; background:${col[i]}"></div></div></div><div class="ms-3 fw-800 small" style="color:${col[i]}">${p}%</div></div>`; }).join(''); }); }
  
  /** Fetches all wallet balance states */
  function loadWallets(){runServer("getWalletBalances",null,res=>{walBalArr=res;const opts=res.map(w=>{const safe=escapeHtml(w.name);return `<option value="${safe}">${safe}</option>`}).join('');document.getElementById('wallet').innerHTML=opts;document.getElementById('walletTujuan').innerHTML=opts;updateSaldoDisplay();});}

  /** Renders transaction list with pagination */
  function renderTrx() {
    const list = document.getElementById('transaction-list'), pag = document.getElementById('pagination-ctrl');
    if (!allTrx.length) {
      list.innerHTML = '<p class="text-center py-5 small opacity-50 fw-bold">Belum ada data transaksi</p>';
      pag.style.setProperty('display', 'none', 'important');
      return;
    }
    pag.style.setProperty('display', 'flex', 'important');
    const totalPages = Math.ceil(allTrx.length / rows);
    const slice = allTrx.slice((curPage - 1) * rows, curPage * rows);
    list.innerHTML = slice.map((t, i) => {
      const realIdx = ((curPage - 1) * rows) + i;
      const isInc = t.tipe.includes('In') || t.tipe === 'Pemasukan';
      const col = getDynamicColor(t.kat);
      return `<div class="trx-item-wrapper"><div class="slide-action action-edit" onclick="handleEdit(${realIdx})">EDIT</div><div class="slide-action action-delete" onclick="handleDelete(${realIdx})">HAPUS</div><div class="trx-card-old" id="card-${realIdx}" style="border-left-color: ${col}" ontouchstart="ts(event, ${realIdx})" ontouchmove="tm(event, ${realIdx})" ontouchend="te(event, ${realIdx})"><div class="cat-icon-box" style="background:${col}15; color:${col}">${getDynamicIcon(t.kat)}</div><div class="flex-grow-1"><div class="small fw-bold">${escapeHtml(t.kat)}</div><div class="text-muted" style="font-size:0.7rem; line-height:1.2; margin-bottom:2px;">${escapeHtml(t.note || '-')}</div><div class="text-muted" style="font-size:0.6rem; opacity:0.8;">${t.tgl} ‚Ä¢ ${escapeHtml(t.wallet)}</div></div><div class="fw-800 ${isInc ? 'text-success' : 'text-danger'} text-nowrap ms-2" style="font-size:0.9rem">${isInc ? '+' : '-'} Rp ${(t.nominal||0).toLocaleString('id-ID')}</div></div></div>`;
    }).join('');
    document.getElementById('pageDisplay').innerText = `${curPage} / ${totalPages}`;
    document.getElementById('btn-prev').disabled = (curPage === 1);
    document.getElementById('btn-next').disabled = (curPage === totalPages);
  }

  /** Validates and sends transaction data to server */
  function handleSave(e) { e.preventDefault(); if (document.getElementById('kategori').value === 'Lainnya' && !document.getElementById('kategoriKustom').value.trim()) { alert("Isi kategori!"); return; } const p = { tipe: document.getElementById('tipe').value, kategori: document.getElementById('kategori').value, kategoriKustom: document.getElementById('kategoriKustom').value, wallet: document.getElementById('wallet').value, walletTujuan: document.getElementById('walletTujuan').value, jumlah: document.getElementById('jumlah').value.replace(/[^0-9]/g, ""), catatan: document.getElementById('catatan').value, tgl: document.getElementById('tglInput').value, rowId: document.getElementById('editRowId').value, trxId: document.getElementById('editRowId').dataset.trxid || "" }; runServer("simpanTransaksi", p, ()=>{ document.getElementById('mainForm').reset(); document.getElementById('editRowId').value = ""; document.getElementById('editRowId').dataset.trxid = ""; document.getElementById('btn-submit').innerText = "SIMPAN TRANSAKSI"; setDefaultDate(); toggleUI(); loadWallets(); fetchTransactions(); showToast(); }); }
  
  /** Toggles form fields based on transaction type */
  function toggleUI() { const t = document.getElementById('tipe').value; document.getElementById('kat-area').style.display = t === 'Transfer' ? 'none' : 'block'; document.getElementById('tujuan-area').style.display = t === 'Transfer' ? 'block' : 'none'; const cats = (t === 'Pemasukan') ? ["Gaji", "Bisnis", "Investasi", "Hadiah", "Fintech", "Lainnya"] : ["Makan & Minum", "Transportasi", "Belanja", "Tempat Tinggal", "Keluarga", "Hiburan", "Fintech", "Kesehatan", "Teman", "Hewan Peliharaan", "Keuangan", "Pribadi", "Sistem", "Lainnya"]; document.getElementById('kategori').innerHTML = cats.map(k => `<option value="${k}">${k}</option>`).join(''); checkLainnya(); }
  
  /** Toggles custom category input field */
  function checkLainnya() { document.getElementById('kat-kustom-area').style.display = document.getElementById('kategori').value === 'Lainnya' ? 'block' : 'none'; }
  
  /** Shows or hides custom date picker */
  function toggleCustomFilter(type) { const box = document.getElementById(`custom-date-${type}`); const cur = box.style.getPropertyValue('display') === 'flex'; box.style.setProperty('display', cur ? 'none' : 'flex', 'important'); [7, 30, 365].forEach(v => { const el = document.getElementById(`${type.toLowerCase()}-d-${v}`); if(el) el.classList.remove('active'); }); document.getElementById(`${type.toLowerCase()}-d-custom`).classList.add('active'); }
  
  /** Applies custom date range for filtering */
  function applyCustomDate(type) { const s = document.getElementById(`${type.toLowerCase()}-start`).value, e = document.getElementById(`${type.toLowerCase()}-end`).value; if(!s || !e) return; if(type === 'H') { hF.start = s; hF.end = e; fetchTransactions(); } else { sF.start = s; sF.end = e; fetchDashboard(); } }
  
  /** Updates history filters with preset range */
  function updateHDate(d) { document.getElementById('custom-date-H').style.setProperty('display', 'none', 'important'); const t = new Date(), p = new Date(t.getTime() - ((d - 1) * 24 * 60 * 60 * 1000)); hF.start = p.toISOString().split('T')[0]; hF.end = t.toISOString().split('T')[0]; [7, 30, 365].forEach(v => { const el = document.getElementById('h-d-' + v); if(el) el.classList.toggle('active', d === v); }); document.getElementById('h-d-custom').classList.remove('active'); fetchTransactions(); }
  
  /** Updates statistics filters with preset range */
  function updateSDate(d) { document.getElementById('custom-date-S').style.setProperty('display', 'none', 'important'); const t = new Date(), p = new Date(t.getTime() - ((d - 1) * 24 * 60 * 60 * 1000)); sF.start = p.toISOString().split('T')[0]; sF.end = t.toISOString().split('T')[0]; [7, 30, 365].forEach(v => { const el = document.getElementById('s-d-' + v); if(el) el.classList.toggle('active', d === v); }); document.getElementById('s-d-custom').classList.remove('active'); fetchDashboard(); }
  
  /** Changes transaction type filter for statistics */
  function updateSFilter(k, v) { sF[k] = v; ['Pemasukan', 'Pengeluaran'].forEach(t => { const btn = document.getElementById('s-t-' + t); if(btn) btn.classList.toggle('active', sF.tipe === t); }); fetchDashboard(); }
  
  /** Navigates history page */
  function changePage(d) { curPage += d; renderTrx(); window.scrollTo({ top: 0, behavior: 'smooth' }); }
  
  /** Sets current date and time as default */
  function setDefaultDate() { const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); document.getElementById('tglInput').value = now.toISOString().slice(0, 16); }
  
  /** Requests and displays export preview data */
  function processExport(){const s=document.getElementById('ex-start').value,e=document.getElementById('ex-end').value;if(!s||!e){alert("Pilih tanggal!");return;}runServer("getExportData",[s,e],data=>{document.getElementById('export-preview-area').style.setProperty('display','block','important');document.getElementById('export-body').innerHTML=data.map(r=>`<tr><td>${r.kode}</td><td>${r.tgl}</td><td>${escapeHtml(r.wallet)}</td><td>${escapeHtml(r.keterangan)}</td><td>${escapeHtml(r.catatan)}</td><td class="text-success">${r.debit?'Rp '+r.debit.toLocaleString('id-ID'):'-'}</td><td class="text-danger">${r.kredit?'Rp '+r.kredit.toLocaleString('id-ID'):'-'}</td><td>Rp ${r.total.toLocaleString('id-ID')}</td></tr>`).join('');});}
  
  /** Triggers CSV file download from table data */
  function downloadCSV() { const table = document.getElementById("table-export"); let csv = []; for (let i = 0; i < table.rows.length; i++) { let row = [], cols = table.rows[i].querySelectorAll("td, th"); for (let j = 0; j < cols.length; j++) row.push('"' + cols[j].innerText.replace(/Rp\s?|(?<=\d)\.(?=\d{3})/g, '').replace(/\n/g, ' ') + '"'); csv.push(row.join(",")); } const blob = new Blob(["\uFEFF" + csv.join("\n")], { type: "text/csv;charset=utf-8;" }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `Export_${new Date().getTime()}.csv`; document.body.appendChild(link); link.click(); document.body.removeChild(link); }

  /** Initialize app on load */
  window.onload = () => { setDefaultDate(); loadWallets(); updateHDate(30); updateSDate(30); toggleUI(); };
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>